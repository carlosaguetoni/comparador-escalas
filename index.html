<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Comparador de Escalas</title>
  <style>
    @media print {
      form, button {
        display: none;
      }
      h1 {
        text-align: center;
        font-size: 18px;
        margin-bottom: 10px;
      }
      body {
        margin: 10px;
        font-size: 10px;
        font-family: Arial, sans-serif;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 10px;
      }
      th {
        background-color: #f2f2f2;
        font-size: 11px;
        padding: 6px 8px;
      }
      td {
        padding: 6px 8px;
        border: 1px solid #ccc;
        vertical-align: top;
      }
      tr.folga {
        background-color: #e0e0e0 !important;
      }
      tr.sem-escala {
        background-color: #fdd9e0 !important;
      }
      .escala-bloco span {
        font-size: 9px;
      }
      .sem-escala {
        color: #999;
        font-size: 9px;
        font-style: italic;
      }
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      vertical-align: top;
    }
    th {
      background-color: #f2f2f2;
      font-size: 16px;
    }
    .sem-escala {
      color: gray;
      font-style: italic;
    }
    .folga {
      background-color: #e0e0e0;
    }
    tr.sem-escala {
      background-color: #ffe6e6;
    }
  </style>
</head>
<body>
  <h1 id="titulo">Comparar Escalas de Tripulantes</h1>

  <form id="formulario" enctype="multipart/form-data">
    <label>Escala 1 (PDF):</label><br>
    <input type="file" name="pdf1" accept="application/pdf" required><br><br>

    <label>Escala 2 (PDF):</label><br>
    <input type="file" name="pdf2" accept="application/pdf" required><br><br>

    <button type="submit">Comparar</button>
  </form>

  <hr>

  <div id="resultado"></div>

  <button onclick="window.print()">Imprimir ou Salvar como PDF</button>

  <script>
    const form = document.getElementById('formulario');
    const resultado = document.getElementById('resultado');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const resposta = await fetch('/comparar', {
        method: 'POST',
        body: formData
      });

      const dados = await resposta.json();
      console.log('Dados recebidos do servidor:', dados);

      // Atualizar título com mês por extenso
      const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      const titulo = document.getElementById('titulo');
      if (dados.mes1) {
        const mesExtenso = meses[parseInt(dados.mes1, 10) - 1];
        titulo.innerText = `Comparador de Escalas – ${mesExtenso}`;
      }

      if (dados.mes1 && dados.mes2 && dados.mes1 !== dados.mes2) {
        const continuar = confirm("As escalas são de meses diferentes. Deseja continuar mesmo assim?");
        if (!continuar) {
          resultado.innerHTML = "<p>Comparação cancelada pelo usuário.</p>";
          return;
        }
      }

      if (!dados.escalas || !Array.isArray(dados.escalas)) {
        resultado.innerHTML = '<p>Não foi possível exibir as escalas.</p>';
        return;
      }

      function ehSoFolga(texto) {
        return (
          texto.includes('off') &&
          !/(AD\s?\d+|Apresentação|Release|Hotel|Reserva|Ground)/i.test(texto)
        );
      }

      let html = '<table>';
      html += `
        <tr>
          <th>Data</th>
          <th>${dados.nome1 || 'Escala 1'}</th>
          <th>${dados.nome2 || 'Escala 2'}</th>
        </tr>
      `;

      dados.escalas.forEach(item => {
        const diaSemana = getDiaSemana(item.data);
        const textoEscala1 = item.escala1.toLowerCase();
        const textoEscala2 = item.escala2.toLowerCase();

        const ambosFolga = ehSoFolga(textoEscala1) && ehSoFolga(textoEscala2);
        const umFolgaOutroSemEscala =
          (ehSoFolga(textoEscala1) && (!textoEscala2 || textoEscala2.trim() === '')) ||
          (ehSoFolga(textoEscala2) && (!textoEscala1 || textoEscala1.trim() === ''));

        const rowClass = ambosFolga ? 'folga' : (umFolgaOutroSemEscala ? 'sem-escala' : '');

        html += `
          <tr class="${rowClass}">
            <td>${diaSemana}, ${item.data}</td>
            <td>${formatarEscala(item.escala1)}</td>
            <td>${formatarEscala(item.escala2)}</td>
          </tr>
        `;
      });

      html = `
        <p style="font-weight: bold; font-size: 12px; margin-bottom: 10px;">
          ${dados.nome1}: ${dados.flightTotal1} | ${dados.nome2}: ${dados.flightTotal2}
        </p>
      ` + html;

      resultado.innerHTML = html;
    });

    function getDiaSemana(data) {
      const [dia, mes, ano] = data.split('/').map(Number);
      const dateObj = new Date(ano, mes - 1, dia);
      const dias = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
      return dias[dateObj.getDay()];
    }

    function formatarEscala(escala) {
      if (!escala) return '<span class="sem-escala">Sem escala</span>';

      return escala
        .split('|')
        .map(item => {
          let texto = item.trim();
          texto = texto.replace(/trainee/gi, '').trim();
          texto = texto.replace(/Flight Time:.*$/i, '').trim();

          const matchApresentacao = texto.match(/^(Apresentação|Release|Hotel)(\d{2}:\d{2}\s*-\s*\d{2}:\d{2}(?:\s*\+?\d+)?)(.*)$/);
          if (matchApresentacao) {
            return `
              <div style="display: grid; grid-template-columns: 100px 110px 1fr; gap: 4px;">
                <span>${matchApresentacao[1]}</span>
                <span>${matchApresentacao[2]}</span>
                <span>${matchApresentacao[3].trim()}</span>
              </div>
            `;
          }

          const matchVoo = texto.match(/^(AD\s?\d{3,4})\b.*?(\d{2}:\d{2}\s*-\s*\d{2}:\d{2}).*?([A-Z]{3}\s*-\s*[A-Z]{3})/);
          if (matchVoo) {
            return `
              <div style="display: grid; grid-template-columns: 100px 110px 1fr; gap: 4px;">
                <span>${matchVoo[1]}</span>
                <span>${matchVoo[2]}</span>
                <span>${matchVoo[3]}</span>
              </div>
            `;
          }

          const matchGround = texto.match(/^(Ground\s?\(.*?\))(\d{2}:\d{2}\s*-\s*\d{2}:\d{2})([A-Z]{3}.*)$/);
          if (matchGround) {
            return `
              <div style="display: grid; grid-template-columns: 100px 110px 1fr; gap: 4px;">
                <span>${matchGround[1]}</span>
                <span>${matchGround[2]}</span>
                <span>${matchGround[3]}</span>
              </div>
            `;
          }

          return `<div style="margin: 5px 0;">${texto}</div>`;
        })
        .join('');
    }
  </script>
</body>
</html>
